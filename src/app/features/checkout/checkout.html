<app-header></app-header>
<section class="max-w-6xl mx-auto px-4 md:px-6 lg:px-8 py-8">
  <!-- Progression -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-8">
    <div class="flex items-center">
      <div class="w-10 h-10 rounded-full flex items-center justify-center"
           [class.bg-blue-600]="step>=1" [class.text-white]="step>=1" [class.bg-gray-200]="step<1">1</div>
      <div class="flex-1 h-1 mx-3 bg-gray-200">
        <div class="h-full" [class.bg-blue-600]="step>=2"></div>
      </div>
      <div class="w-10 h-10 rounded-full flex items-center justify-center"
           [class.bg-blue-600]="step>=2" [class.text-white]="step>=2" [class.bg-gray-200]="step<2">2</div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
    <!-- Formulaire -->
    <div class="lg:col-span-8">
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">

        <!-- Étape 1 -->
        <!-- Étape 1 -->
<form *ngIf="step === 1" [formGroup]="step1" (ngSubmit)="nextFromStep1()">
  <h2 class="text-xl font-bold mb-4">Adresse de Livraison</h2>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div>
      <label class="text-sm font-medium mb-1 block">Prénom *</label>
      <input class="w-full px-3 py-2 border rounded-lg" formControlName="firstName">
      <p class="text-red-600 text-xs mt-1" *ngIf="step1.controls.firstName.touched && step1.controls.firstName.invalid">
        Prénom requis
      </p>
    </div>
    <div>
      <label class="text-sm font-medium mb-1 block">Nom *</label>
      <input class="w-full px-3 py-2 border rounded-lg" formControlName="lastName">
      <p class="text-red-600 text-xs mt-1" *ngIf="step1.controls.lastName.touched && step1.controls.lastName.invalid">
        Nom requis
      </p>
    </div>
  </div>

  <div class="mt-4">
    <label class="text-sm font-medium mb-1 block">Adresse *</label>
    <input class="w-full px-3 py-2 border rounded-lg" formControlName="address">
    <p class="text-red-600 text-xs mt-1" *ngIf="step1.controls.address.touched && step1.controls.address.invalid">
      Adresse requise
    </p>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
    <div>
      <label class="text-sm font-medium mb-1 block">Ville *</label>
      <input class="w-full px-3 py-2 border rounded-lg" formControlName="city">
      <p class="text-red-600 text-xs mt-1" *ngIf="step1.controls.city.touched && step1.controls.city.invalid">
        Ville requise
      </p>
    </div>
    <div>
      <label class="text-sm font-medium mb-1 block">Code Postal *</label>
      <input class="w-full px-3 py-2 border rounded-lg" formControlName="postalCode">
      <p class="text-red-600 text-xs mt-1" *ngIf="step1.controls.postalCode.touched && step1.controls.postalCode.invalid">
        Code postal requis
      </p>
    </div>
  </div>

  <div class="mt-4">
    <label class="text-sm font-medium mb-1 block">Téléphone *</label>
    <input class="w-full px-3 py-2 border rounded-lg" formControlName="phone">
    <p class="text-red-600 text-xs mt-1" *ngIf="step1.controls.phone.touched && step1.controls.phone.invalid">
      Téléphone requis
    </p>
  </div>

  <h3 class="text-lg font-semibold mt-6 mb-3">Mode de Livraison</h3>

  <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-gray-50 select-none">
    <input type="checkbox" class="mr-3" formControlName="useExpress">
    <div class="flex-1">
      <p class="font-semibold">Express</p>
      <p class="text-sm text-gray-600">Livraison rapide (facultatif)</p>
    </div>
    <span class="font-bold">+ 4.00 DT</span>
  </label>


  <button type="submit" class="mt-6 w-full bg-[#2563eb] hover:bg-[#1d4ed8] text-white py-3 rounded-lg font-semibold">
    Continuer
  </button>
</form>

<!-- Étape 2 -->
<form *ngIf="step === 2" [formGroup]="step2" (ngSubmit)="pay()">
  <h2 class="text-xl font-bold mb-4">Paiement</h2>

  <div class="mb-4">
    <label class="text-sm font-medium mb-1 block">Numéro de Carte *</label>
    <input class="w-full px-3 py-2 border rounded-lg" placeholder="1234 5678 9012 3456" maxlength="16" formControlName="cardNumber">
    <p class="text-red-600 text-xs mt-1" *ngIf="step2.controls.cardNumber.touched && step2.controls.cardNumber.invalid">
      Numéro de carte invalide
    </p>
  </div>

  <div class="mb-4">
    <label class="text-sm font-medium mb-1 block">Nom sur la Carte *</label>
    <input class="w-full px-3 py-2 border rounded-lg" formControlName="cardName">
    <p class="text-red-600 text-xs mt-1" *ngIf="step2.controls.cardName.touched && step2.controls.cardName.invalid">
      Nom requis
    </p>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
    <div>
      <label class="text-sm font-medium mb-1 block">Date d'Expiration *</label>
      <input class="w-full px-3 py-2 border rounded-lg" placeholder="MM/AA" formControlName="expiryDate">
      <p class="text-red-600 text-xs mt-1" *ngIf="step2.controls.expiryDate.touched && step2.controls.expiryDate.invalid">
        Date invalide (MM/AA)
      </p>
    </div>
    <div>
      <label class="text-sm font-medium mb-1 block">CVV *</label>
      <input class="w-full px-3 py-2 border rounded-lg" maxlength="3" placeholder="123" formControlName="cvv">
      <p class="text-red-600 text-xs mt-1" *ngIf="step2.controls.cvv.touched && step2.controls.cvv.invalid">
        CVV invalide
      </p>
    </div>
  </div>

  <div class="flex gap-4">
    <button type="button" (click)="backToStep1()" class="px-6 py-2 border rounded-lg hover:bg-gray-50">Retour</button>
    <button type="submit" [disabled]="loading" class="flex-1 bg-[#2563eb] hover:bg-[#1d4ed8] text-white py-3 rounded-lg font-semibold">
      {{ loading ? 'Traitement...' : ('Payer ' + (total | number:'1.2-2') + ' DT') }}
    </button>
  </div>
</form>

      </div>
    </div>

    <!-- Récapitulatif -->
    <aside class="lg:col-span-4">
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 sticky top-24">
        <h2 class="text-xl font-bold mb-4">Récapitulatif</h2>

        <div class="space-y-3 mb-4 max-h-60 overflow-y-auto">
          <div *ngFor="let item of cart" class="flex gap-3">
            <img [src]="item.image" (error)="onImgError($event, item)" [alt]="item.name" class="w-16 h-16 object-cover rounded border" />
            <div class="flex-1">
              <p class="font-semibold text-sm">{{ item.name }}</p>
              <p class="text-sm text-gray-600">Qté: {{ item.quantity }}</p>
            </div>
            <span class="font-bold">{{ (item.price * item.quantity) | number:'1.2-2' }} DT</span>
          </div>
        </div>

        <div class="border-t pt-4 space-y-2 text-sm">
          <div class="flex justify-between">
            <span>Sous-total</span>
            <span>{{ subtotal | number:'1.2-2' }} DT</span>
          </div>
          <div class="flex justify-between">
            <span>Livraison</span>
            <span>{{ shipping | number:'1.2-2' }} DT</span>
          </div>
          <div class="border-t pt-2 flex justify-between font-bold text-lg">
            <span>Total</span>
            <span class="text-[#2563eb]">{{ total | number:'1.2-2' }} DT</span>
          </div>
        </div>
      </div>
    </aside>
  </div>
</section>
<app-footer></app-footer>
